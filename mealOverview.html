<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="styles.css">
        <title>Meal Overview | Good Eats</title>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Good Eats</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="home.html">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="searchMeals.html">Search</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="createRecipe.html">New Recipe</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="mealRankings.html">Rankings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="recommendations.html">Recommendations</a>
                </li>
              </ul>
              <div class="form-inline my-2 my-lg-0">
                <button class="btn btn-danger mr-2" type="button" id="logout">Logout</button>
              </div>
            </div>
          </nav>
        <h1 id="meal_name"></h1>
        <div id="meal_image"></div>
        <div id="origin_category"></div>
        <div id="meal_tags"></div>
        <div id="rating"></div>
        <div id="meal_instructions"></div>
        <div id="ingredients"></div>
        <div id="video"></div>
        <form action="rateRequest.php" method="post">
        	<label for="rating">Rate this Recipe:</label>
        <select name="rating" id="ratingSELECT">
        	<option value="1">1</option>
        	<option value="2">2</option>
        	<option value="3">3</option>
        	<option value="4">4</option>
        	<option value="5">5</option>
        </select>
         <input type="button" value="Submit" onclick="SendRatingData()" />
        </form>
        <div id="comments-section">
        <form id="comment-form">
            <div class="form-group">
                <label for="comment">Join the Discussion:</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="Enter your comments here" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
        <div id="comments-list">
        </div>
        </div>
    </body>
</html>

<script>
    function getCookieValue(cookieName) {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(`${cookieName}=`)) {
                return cookie.substring(cookieName.length + 1);
            }
        }
    }

    function RequestSessionValidation(ID) {
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleSessionResponse(response);
            }
        };
        request.send("type=validate_session&sessionID=" + ID);
        console.log("Request Sent");
    }
    function HandleSessionResponse(response) {
        var msgObject = document.getElementById("msg");
        var msgObject2 = document.getElementById("msg2")
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            console.log("Validation Successful.");
        } else {
            console.log("Invalid session found.");
            location.href = "index.html";
        }
    }
    
    function SendLogoutRequest(ID){
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleLogoutResponse(response);
            }
        };
        request.send("type=logout&sessionID=" + ID);
        console.log("Request Sent");
    }

    function HandleLogoutResponse(response) {
        var msgObject = document.getElementById("msg");
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            console.log("Logout Successful.");
            location.href = "index.html"

        } else {
            console.log("Error logging out.");
        }
    }

        var btn = document.getElementById('logout');
        btn.addEventListener("click", function(){
            SendLogoutRequest(getCookieValue("sessionID"));
        });

    function mealDetailRequestAPI(query) {
        var request = new XMLHttpRequest();
        request.open("POST", "searchRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleMealResponse(response);
            }
        };
        request.send("type=mealDetails&query=" + query);
        console.log("Meal Details Request Sent");
    }

    function mealDetailRequestDB(query) {
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleMealResponse(response);
            }
        };
        request.send("type=mealDetails&sessionID=" + query);
        console.log("Meal Details Request Sent");
    }

    function HandleMealResponse(response) {
        var meal_name = document.getElementById("meal_name");
        var meal_image = document.getElementById("meal_image");
        var origin_category = document.getElementById("origin_category");
        var meal_tags = document.getElementById("meal_tags");
        var meal_instructions = document.getElementById("meal_instructions");
        var ingredients = document.getElementById("ingredients");
        var video = document.getElementById("video");
        
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            var messageArray = responseObject.message;
            
            var name = document.createElement("h1");
            name.innerText = messageArray.strMeal;
            var image = document.createElement("img");
            image.src = messageArray.strMealThumb;
            var originCategory = document.createElement('h3');
            originCategory.innerText = messageArray.strArea + "/" + messageArray.strCategory;
            var tags = document.createElement("p");
            tags.innerText = messageArray.strTags;
            var steps = document.createElement("p");
            steps.innerText = messageArray.strInstructions;
            var videoEmbed = document.createElement("iframe");
            videoEmbed.width = "1280";
            videoEmbed.height = "720";
            videoEmbed.src = messageArray.strYoutube;
            videoEmbed.allowfullscreen = true;
            var ingredientsList = document.createElement("ul");
            for (var i = 1; i <= 20; i++) {
                var measurement = messageArray["strMeasure" + i];
                var ingredient = messageArray["strIngredient" + i];
                if (measurement && ingredient) {
                    var listItem = document.createElement("li");
                    listItem.innerText = measurement + " " + ingredient;
                    ingredientsList.appendChild(listItem);
                } else {
                    break;
                }
            }
            meal_name.appendChild(name);
            meal_image.appendChild(image);
            origin_category.appendChild(originCategory);
            meal_tags.appendChild(tags);
            meal_instructions.appendChild(steps);
            ingredients.appendChild(ingredientsList);
            video.appendChild(videoEmbed);
        }
    }

    RequestSessionValidation(getCookieValue("sessionID"));

    function getMealIdFromQuery() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            return urlParams.get("mealId");
        }

    function getSourceFromQuery(){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        return urlParams.get("origin")
    }

    window.addEventListener('load', function () {
            const mealId = getMealIdFromQuery();
            const source = getSourceFromQuery();
            if (source == "external") {
                mealDetailRequestAPI(mealId);
            } else if (source == "internal") {
                mealDetailRequestDB(mealId);
            }else{
                window.location.href = "home.html";
            }
        });
     
        function SendRatingRequest(mealID, accountID, rating) {
            var request = new XMLHttpRequest();
            request.open("POST", "ratingRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleRatingResponse(response);
            }
        };
        request.send(
            "type=rate&accountID=" +
                accountID +
                "&mealID=" +
                mealID +
                "&rating=" +
                rating
        );
        console.log("Request Sent");
    }

    function SendRatingData() {
        var mealID = getMealIdFromQuery();;
        var accountID = getCookieValue("username");
        var rating = document.getElementById("ratingSELECT").value;
        SendRatingRequest(mealID, accountID, rating);
    }

    function HandleRatingResponse(response) {
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            window.alert("Recipe Rated Successfully.");
            RequestMealRating(getMealIdFromQuery());
        } else {
            console.log(responseObject);
            window.alert("Error while trying to rate meal.")
            console.log("Recipe Rating Failed: " + responseObject.message);
        }
    }

    function RequestMealRating(mealID) {
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleGetRating(response);
            }
        };
        request.send("type=getMealRating&sessionID=" + mealID);
        console.log("Request Sent");
    }
    
    function HandleGetRating(response) {
    var responseObject = JSON.parse(response);
    var ratingDiv = document.getElementById("rating");
    var rating = document.getElementById("ratingSELECT").value;
    ratingDiv.innerText = "Rating: " + rating;
    }

    document.getElementById('comment-form').addEventListener('submit', function(event) {
            event.preventDefault();
            let commentText = document.getElementById('comment').value;
            let commenterName = getCookieValue("username");
            let commentsList = document.getElementById('comments-list');
            let commentDiv = document.createElement('div');
            let mealID = getMealIdFromQuery();
            console.log(mealID);
            sendComment(mealID, commenterName, commentText);
            commentDiv.classList.add('comment');
            commentDiv.innerHTML = '<p><strong>' + commenterName + ':</strong> <p>' + commentText + '</p><span class="comment-date">' + new Date().toLocaleString() + '</span>';
            commentsList.appendChild(commentDiv);
            document.getElementById('comment').value = '';
        });
    
        function requestComments(mealID) {
            var request = new XMLHttpRequest();
            request.open("POST", "commentsRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleGetComments(response);
                }
            };
            request.send("type=getComments&mealID=" + mealID);
            console.log("Comments Request Sent");
        }

        function sendComment(mealID, username, content) {
            var request = new XMLHttpRequest();
            request.open("POST", "commentsRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleSendComments(response);
                }
            };
            request.send("type=sendComments&mealID=" + mealID + "&username=" + username + "&content=" + content);
            console.log("Comments Request Sent");
        }

    function HandleGetComments(response) {
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode === 1) {
            let comments = responseObject.comments;
            let commentsList = document.getElementById('comments-list');
            if (comments.length > 0) {
                comments.forEach(function(comment) {
                    let commentDiv = document.createElement('div');
                    commentDiv.classList.add('comment');
                    commentDiv.innerHTML = '<p><strong>' + comment.username + ':</strong> <p>' + comment.content + '</p><span class="comment-date">' + comment.postDate + '</span>';
                    commentsList.appendChild(commentDiv);
                });
            }
        }
    }
    function HandleSendComments(response){
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            window.alert("Comment Successfully Added.");
        }
    }
    requestComments(getMealIdFromQuery());
    
    </script>