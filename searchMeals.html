<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="styles.css">
        <title>Search Meals | Good Eats</title>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Good Eats</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="home.html">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="searchMeals.html">Search</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="createRecipe.html">New Recipe</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="mealRankings.html">Rankings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="recommendations.html">Recommendations</a>
                </li>
              </ul>
              <div class="form-inline my-2 my-lg-0">
                <button class="btn btn-danger mr-2" type="button" id="logout">Logout</button>
              </div>
            </div>
          </nav>
        <h1 id="msg">Search Meals</h1>
        <h2 id="msg2">
            <input type="text" id="mealKeyword" autofocus required>
            <input type="button" id="excuteSearch" value="Go" onclick="goButton()"/>
        </h2>
        <div id="api_content"></div>
    </body>
</html>

<script>
    function getCookieValue(cookieName) {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(`${cookieName}=`)) {
                return cookie.substring(cookieName.length + 1);
            }
        }
    }

    function RequestSessionValidation(ID) {
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleSessionResponse(response);
            }
        };
        request.send("type=validate_session&sessionID=" + ID);
        console.log("Request Sent");
    }
    function HandleSessionResponse(response) {
        var msgObject = document.getElementById("msg");
        var msgObject2 = document.getElementById("msg2")
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            console.log("Validation Successful.");
        } else {
            console.log("Invalid session found.");
            location.href = "index.html";
        }
    }
    
    function SendLogoutRequest(ID){
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleLogoutResponse(response);
            }
        };
        request.send("type=logout&sessionID=" + ID);
        console.log("Request Sent");
    }

    function HandleLogoutResponse(response) {
        var msgObject = document.getElementById("msg");
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            console.log("Logout Successful.");
            location.href = "index.html"

        } else {
            console.log("Error logging out.");
        }
    }

        var btn = document.getElementById('logout');
        btn.addEventListener("click", function(){
            SendLogoutRequest(getCookieValue("sessionID"));
        });
    
    function goButton(){
        var searchKeywords = document.getElementById("mealKeyword").value;
        RequestSessionValidation(getCookieValue("sessionID"));
        searchAPIRequest(searchKeywords);
        searchDBRequest(searchKeywords);
    }
    function searchAPIRequest(query) {
        var request = new XMLHttpRequest();
        request.open("POST", "searchRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleAPISearchResponse(response);
            }
        };
        request.send("type=searchMeals&query=" + query);
        console.log("Search Request Sent");
    }
    function searchDBRequest(query) {
        var request = new XMLHttpRequest();
        request.open("POST", "sessionRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleDBSearchResponse(response);
            }
        };
        request.send("type=searchMeals&sessionID=" + query);
        console.log("Search Request Sent");
    }
    
    function HandleAPISearchResponse(response) {
    var msgObject = document.getElementById("api_content");
    var responseObject = JSON.parse(response);
    if (responseObject.returnCode == 1) {
        var messageArray = responseObject.message;
        for (var i = 0; i < messageArray.length; i++) {
            var item = messageArray[i];
            var image = document.createElement("img");
            image.src = item.strMealThumb;
            var mealLink = document.createElement("a");
            mealLink.href = "#";
            mealLink.innerText = item.strMeal;
            mealLink.setAttribute("data-mealid", item.idMeal);
            mealLink.setAttribute("data-source", "external");
            mealLink.addEventListener("click", handleMealLinkClick);
            var origin = document.createElement("p");
            origin.textContent = item.strArea;
            var itemDiv = document.createElement("div");
            itemDiv.classList.add("api-item");
            itemDiv.appendChild(image);
            itemDiv.appendChild(mealLink);
            itemDiv.appendChild(origin);
            msgObject.appendChild(itemDiv);
        }
    }
}

function HandleDBSearchResponse(response, source) {
    var msgObject = document.getElementById("api_content");
    var responseObject = JSON.parse(response);
    if (responseObject.returnCode == 1) {
        var messageArray = responseObject.message;
        messageArray.forEach(function(item) {
            var image = document.createElement("img");
            image.src = item.strMealThumb;

            var mealLink = document.createElement("a");
            mealLink.href = "#";
            mealLink.innerText = item.strMeal;
            mealLink.setAttribute("data-mealid", item.id);
            mealLink.setAttribute("data-source", "internal");
            mealLink.addEventListener("click", handleMealLinkClick);
            var origin = document.createElement("p");
            origin.textContent = item.strArea;
            var itemDiv = document.createElement("div");
            itemDiv.classList.add("db-item");
            itemDiv.appendChild(image);
            itemDiv.appendChild(mealLink);
            itemDiv.appendChild(origin);

            msgObject.appendChild(itemDiv);
        });
    }
}


    function handleMealLinkClick(event) {
        event.preventDefault();
        var source = event.currentTarget.getAttribute("data-source");
        var mealId = event.target.getAttribute("data-mealid");
        if (source === "internal") {
            window.location.href = "mealOverview.html?origin=" + source + "&mealId=" + mealId;
            console.log("Clicked from SQL database");
        } else if (source === "external") {
            window.location.href = "mealOverview.html?origin=" + source + "&mealId=" + mealId;
            console.log("Clicked from API endpoint");
        }
    }

    RequestSessionValidation(getCookieValue("sessionID"));

</script>