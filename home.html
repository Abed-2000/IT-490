<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="styles.css">
        <title>Home | Good Eats</title>

    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Good Eats</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="home.html">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="searchMeals.html">Search</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="createRecipe.html">New Recipe</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="mealRankings.html">Rankings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="recommendations.html">Recommendations</a>
                </li>
              </ul>
              <div class="form-inline my-2 my-lg-0">
                <button class="btn btn-danger mr-2" type="button" id="logout">Logout</button>
              </div>
            </div>
          </nav>
        <h1 id="msg"></h1>
        <h3>Rated Recipes:</h3>
        <div onload="getRecipes()" id="api_content"></div>
    </body>
</html>

<script>

    //cookies
        function getCookieValue(cookieName) {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(`${cookieName}=`)) {
                    return cookie.substring(cookieName.length + 1);
                }
            }
        }
    
    //sessions
        function RequestSessionValidation(ID) {
            var request = new XMLHttpRequest();
            request.open("POST", "sessionRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleSessionResponse(response);
                }
            };
            request.send("type=validate_session&sessionID=" + ID);
            console.log("Request Sent");
        }
        function HandleSessionResponse(response) {
            var msgObject = document.getElementById("msg");
            var responseObject = JSON.parse(response);
            if (responseObject.returnCode == 1) {
                console.log("Validation Successful.");
                msgObject.innerHTML = "Welcome " + getCookieValue("username");
            } else {
                console.log("Invalid session found.");
                location.href = "index.html";
            }
        }
        
    //logout
        function SendLogoutRequest(ID){
            var request = new XMLHttpRequest();
            request.open("POST", "sessionRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleLogoutResponse(response);
                }
            };
            request.send("type=logout&sessionID=" + ID);
            console.log("Request Sent");
        }
    
        function HandleLogoutResponse(response) {
            var msgObject = document.getElementById("msg");
            var responseObject = JSON.parse(response);
            if (responseObject.returnCode == 1) {
                console.log("Logout Successful.");
                location.href = "index.html"
    
            } else {
                console.log("Error logging out.");
            }
        }
    
        var btn = document.getElementById('logout');
        btn.addEventListener("click", function(){
            SendLogoutRequest(getCookieValue("sessionID"));
        });
    
    //rated recipes
    
    //gets meal id from user input CHANGE TO FROM DB
        function getRecipes(){
            var searchKeywords = document.getElementById("mealKeyword").value;
            RequestSessionValidation(getCookieValue("sessionID"));
            searchRequest(searchKeywords);
        }
    //sends request of query to rabbit
        function searchRequest(query) {
            var request = new XMLHttpRequest();
            request.open("POST", "searchRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleSearchResponse(response);
                }
            };
            request.send("type=searchMeals&query=" + query);
            console.log("Search Request Sent");
        }
    //returns meal date for meal id, places into div 
        function HandleSearchResponse(response) {
            var msgObject = document.getElementById("api_content");
            msgObject.innerHTML = "";
            var responseObject = JSON.parse(response);
            if (responseObject.returnCode == 1) {
                var messageArray = responseObject.message;
                for (var i=0; i < messageArray.length; i++){
                    var item = messageArray[i];
                    var image = document.createElement("img");
                    image.src = item.strMealThumb;
                    var mealLink = document.createElement("a");
                    mealLink.href = "#";
                    mealLink.innerText = item.strMeal;
                    mealLink.setAttribute("data-mealid", item.idMeal);
                    mealLink.addEventListener("click", handleMealLinkClick);
                    var origin = document.createElement("p");
                    origin.textContent = item.strArea;
                    var ItemDiv = document.createElement("div");
                    ItemDiv.appendChild(image);
                    ItemDiv.appendChild(mealLink);
                    ItemDiv.appendChild(origin);
                    msgObject.appendChild(ItemDiv);
                }
            }
        }
    //redirects to meal page when meal name clicked
        function handleMealLinkClick(event) {
            event.preventDefault();
            var mealId = event.target.getAttribute("data-mealid");
            window.location.href = "mealOverview.html?mealId=" + mealId;
        }

        function SendRatedMealsRequest(accountID) {
            getCookieValue("sessionID");
            var request = new XMLHttpRequest();
            request.open("POST", "ratedMealsRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleRegistrationResponse(response);
                }
            };
            request.send(
                "type=ratereturn&accountID=" +
                    accountID
    
            );
            console.log("Request Sent");
        }
    
        function SendRatingData() {
            var mealID = getCookieValue("mealID");
            var accountID = getCookieValue("userID");
            var rating = document.getElementById("rating").value;
        }
        function HandleRegistrationResponse(response) {
            var responseObject = JSON.parse(response);
            if (responseObject.returnCode == 1) {
                console.log("Recipe Rated Successfully.");
            var complete = document.createElement("p");
                complete.innerText = "Rating saved.";
                complete.appendChild(complete);
            } else {
                console.log(responseObject);
                console.log("Recipe Rating Failed: " + responseObject.message);
            }
        }
        window.addEventListener('load', function () {
            RequestSessionValidation(getCookieValue("sessionID"));
            console.log("session id request send");
            });

    </script>