<!DOCTYPE html>
<html>
    <head>
            <link rel="stylesheet" href="styles.css">
            <title>Home | Good Eats</title>
    </head>
    <body>
        <nav>
            <label>Good Eats<label>
            <input type="button" value="Home" onclick="window.location.href='home.html'" />
            <input type="button" value="New Reciepe" onclick="window.location.href='createRecipe.html'" />
            <input type="button" value="Rankings" onclick="window.location.href='mealRankings.html'" />
            <input type="button" value="Search" onclick="window.location.href='searchMeals.html'" />
            <input type="button" value="Users" onclick="window.location.href='searchUsers.html'" />
            <input type="button" value="Logout" onclick="logoutBtn()" />
        </nav>
        <h1 id="msg"></h1>
        <h3>Rated Recipes:</h3>
        <div onload="getRecipes()" id="api_content"></div>
    </body>
</html>

<script>

    //cookies
        function getCookieValue(cookieName) {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(`${cookieName}=`)) {
                    return cookie.substring(cookieName.length + 1);
                }
            }
        }
    
    //sessions
        function RequestSessionValidation(ID) {
            var request = new XMLHttpRequest();
            request.open("POST", "sessionRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleSessionResponse(response);
                }
            };
            request.send("type=validate_session&sessionID=" + ID);
            console.log("Request Sent");
        }
        function HandleSessionResponse(response) {
            var msgObject = document.getElementById("msg");
            var responseObject = JSON.parse(response);
            if (responseObject.returnCode == 1) {
                console.log("Validation Successful.");
                msgObject.innerHTML = "Welcome " + getCookieValue("username");
            } else {
                console.log("Invalid session found.");
                location.href = "index.html";
            }
        }
        
    //logout
        function SendLogoutRequest(ID){
            var request = new XMLHttpRequest();
            request.open("POST", "sessionRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this);
                    var response = this.responseText;
                    HandleLogoutResponse(response);
                }
            };
            request.send("type=logout&sessionID=" + ID);
            console.log("Request Sent");
        }
    
        function HandleLogoutResponse(response) {
            var msgObject = document.getElementById("msg");
            var responseObject = JSON.parse(response);
            if (responseObject.returnCode == 1) {
                console.log("Logout Successful.");
                location.href = "index.html"
    
            } else {
                console.log("Error logging out.");
            }
        }
    
        function logoutBtn(){
            SendLogoutRequest(getCookieValue("sessionID"));
        }
        
        
        
        
        
        
        
        
        
        
    
    //rated recipes
    function mealDetailRequest(query) {
        var request = new XMLHttpRequest();
        request.open("POST", "searchRequest.php", true);
        request.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleMealResponse(response);
            }
        };
        
        
        
        
        
        
        
        
        
        
        request.send("type=mealDetails&query=" + query);
        console.log("Meal Details Request Sent");
    }
    function HandleMealResponse(response) {
        var meal_name = document.getElementById("meal_name");
        var meal_image = document.getElementById("meal_image");
        
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
         var messageArray = responseObject.message;
            for (var i=0; i < messageArray.length; i++){
            	var messageArray = responseObject.message;
            	var name = document.createElement("h1");
            	name.innerText = messageArray.strMeal;
            	var image = document.createElement("img");
            	image.src = messageArray.strMealThumb;
 		var mealLink = document.createElement("a");
                mealLink.href = "#";
                mealLink.innerText = item.strMeal;
                mealLink.setAttribute("data-mealid", item.idMeal);
                mealLink.addEventListener("click", handleMealLinkClick);
            	meal_name.appendChild(name);
            	meal_image.appendChild(image);
                var ItemDiv = document.createElement("div");
                ItemDiv.appendChild(image);
                ItemDiv.appendChild(mealLink);
                const btn = documentcreateElement("button");
                btn.innerHTML = "Hello Button";
                document.body.appendChild(btn);
                msgObject.appendChild(ItemDiv);
            }
        }
    }
   
    function handleMealLinkClick(event) {
        event.preventDefault();
        var mealId = event.target.getAttribute("data-mealid");
        window.location.href = "mealOverview.html?mealId=" + mealId;
    }
    
    
            function SendUnshareRequest(mealID, accountID) {
            var request = new XMLHttpRequest();
            request.open("POST", "unshareRequest.php", true);
            request.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
        );
        request.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this);
                var response = this.responseText;
                HandleShareResponse(response);
            }
        };
        request.send(
            "type=unshare&accountID=" +
                accountID +
                "&mealID=" +
                mealID
        );
        console.log("Request Sent");
    }

    function SendUnshareData() {
        var mealID = getMealIdFromQuery();
        var accountID = getCookieValue("username");
        SendShareRequest(mealID, accountID);
    }

    function HandleShareResponse(response) {
        var responseObject = JSON.parse(response);
        if (responseObject.returnCode == 1) {
            window.alert("Recipe Unshared Successfully.");
	    var complete = document.createElement("p");
            complete.innerText = "Recipe unshared.";
            document.getElementById("completed").appendChild(complete);
        } else {
            console.log(responseObject);
            window.alert("Error while trying to unshare meal.")
            console.log("Recipe unsharing Failed: " + responseObject.message);
        }
    }

    RequestSessionValidation(getCookieValue("sessionID"));
    
    </script>
